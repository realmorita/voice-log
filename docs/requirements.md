## 1. 目的・背景

### 1.1 目的

* **完全にローカル環境のみ**で音声を文字起こし（CUDA対応で高速化）し、続けて**ローカルLLM**で要約を生成する。
* 要約の品質・運用を高めるため、**要約用プロンプトをMarkdown（.md）ファイルで差し替え／拡張可能**にする（Skills的な運用）。

### 1.2 解決したい課題

* 長時間音声の文字起こしで発生しがちな**同一語の突然の反復（ハルシネーション／ループ）**を抑制する。
* 音声入力（録音）・ファイル入力の両対応、無音区間スキップ、設定の外部化（YAML）により、日常運用できるツールにする。

---

## 2. スコープ

### 2.1 対象範囲（In Scope）

* 音声入力（マイク録音）→ 文字起こし → 要約（任意）
* 音声ファイル入力（wav/mp3/m4a等）→ 文字起こし → 要約（任意）
* テキスト入力（既存文字起こし）→ 要約のみ
* 設定ファイル（YAML）で各種パラメータ変更
* 要約プロンプト（.md）を複数モードで管理・切替
* CUDA利用可否の自動判定とフォールバック（CPU）
* VAD（無音区間スキップ）および stable-ts による整列／無音抑制（任意）

### 2.2 対象外（Out of Scope）

* クラウド音声認識API連携（完全ローカル前提）
* GUI（まずはCLI。将来拡張は可）
* 話者分離（Diarization）は必須ではない（将来拡張扱い）
* リアルタイム字幕（ストリーミング表示）は任意（段階導入）

---

## 3. 想定ユーザー・利用シナリオ

### 3.1 ユーザー

* ローカル環境で議事録・学習・インタビュー記録を作りたい個人／開発者
* プロンプトや出力フォーマットを自分の業務に合わせて調整したいユーザー

### 3.2 主要シナリオ

1. CLI起動 → 録音 → 文字起こし → 要約 → 出力保存
2. CLI起動 → 音声ファイル指定 → 文字起こし → 要約 → 出力保存
3. CLI起動 → 既存テキスト貼付 → 要約のみ → 出力保存
4. プロンプトmdを編集 → 同じ音声で要約だけ再生成（再要約）

---

## 4. システム構成（論理アーキテクチャ）

### 4.1 音声認識スタック

* **API層**: stable-ts
* **推論エンジン層**: faster-whisper（CTranslate2）
* **モデル層**: Whisper large-v3-turbo（推奨）

補助機能：

* **VAD統合（無音区間スキップ）**
* **suppress_silence（タイムスタンプ精度／無音抑制）**
* **GPU/CPU自動切替**
* **compute_type最適化（FP16/INT8）**

### 4.2 要約スタック（完全ローカル）

* **Ollama** をローカルで起動し、OpenAI SDKを使用して要約生成
* 要約プロンプトは `.md` テンプレートとして外出し（設定フォルダ内の`prompts/`フォルダに配置）
* 要約モード（例：議事録／TODO抽出／要点3行／FAQ化など）をディレクトリで管理

---

## 5. 機能要件（FR）

### FR-1: CLI起動時の自己診断

* 設定ファイル（例：`config.yaml`）を読み込み、必須キーを検証する。
* Ollamaのホスト（例：`localhost:11434`）へ疎通確認し、利用可能モデル一覧を表示できる。
* Whisper推論に必要なGPU/CUDA可否を判定し、使用デバイスを表示する。

### FR-2: メニュー操作（画像の構成を踏襲）

最低限、以下の選択肢を提供する：

* [1] 録音して文字起こし（＋要約）
* [2] ファイルから文字起こし（＋要約）
* [3] テキストから要約のみ
* [4] 録音デバイス一覧
* [5] 要約モード一覧
* [6] 設定初期化
* [7] 設定再読み込み
* [0] 終了

### FR-3: 録音入力

* 録音デバイスを列挙し、ID指定で選択できる。
* 録音開始／停止をキー操作で制御できる（例：Enterで開始、Enterで停止）。
* 録音データは一時ファイル（wav）として保存し、後段へ渡す。

### FR-4: 音声ファイル入力

* 対応形式：wav / mp3 / m4a / flac（内部でwavへ変換しても良い）
* 長時間ファイルでも処理できる（チャンク処理対応）

### FR-5: VAD（無音区間スキップ）

* VADを有効化した場合、無音区間を除外して認識を行う。
* VAD閾値や最小発話長、無音判定時間などを設定で調整可能にする。
* 出力テキストに「…」のような無音表現を入れるかどうかを選べる。

### FR-6: 文字起こし（Whisper）

* 既定モデル：`large-v3-turbo`
* CUDA利用時は `device=cuda` を用い、`compute_type`（例：float16 / int8_float16）を設定で選択可能にする。
* **ハルシネーション抑制の既定値**

  * `condition_on_previous_text = False`
  * `word_timestamps = False`（使わない）
  * stable-ts有効化（必要に応じて `suppress_silence` を使用）
* 生成結果の後処理として、同一トークン反復・同一行反復を検知して軽減する（※後述 NFRで品質条件化）

### FR-7: stable-ts（任意）

* 有効化時、整列と無音抑制（`suppress_silence`）を利用できる。
* タイムスタンプ出力（セグメント単位）は任意。**word-levelは既定で無効**。

### FR-8: 出力

* 文字起こし出力：txt / md / json（少なくともtxtとmd）
* 要約出力：md（推奨）＋txt
* 出力先ディレクトリとファイル命名規則（日時＋入力名）を設定可能にする。
* 生成物にメタ情報（モデル名、設定概要、処理時間）をフッターで残せる。

### FR-9: 要約（Ollama）

* 指定モデル（例：Qwen系、Llama系等）で要約を生成する。
* モデル一覧を取得し、設定で選択できる。
* 失敗時（Ollama停止等）は要約をスキップし、文字起こしは成功扱いにする（部分成功）。

### FR-10: 要約プロンプトの.mdカスタマイズ

* `prompts/` 配下にモード別フォルダ（またはファイル）を持つ。

  * 例：`prompts/minutes.md`, `prompts/todo.md`, `prompts/summary_3lines.md`
* `.md` 内にプレースホルダを定義し、実行時に置換してLLMへ送る：

  * `{{TRANSCRIPT}}`（文字起こし全文）
  * `{{TITLE}}`（任意）
  * `{{DATE}}`
  * `{{LANG}}`（ja等）
* モード一覧表示とモード切替ができる（[5]）。

### FR-11: 設定管理

* `config.yaml` で以下を管理：

  * 音声：サンプルレート、チャンネル、デバイスID、録音形式
  * VAD：有効/無効、閾値、無音扱い秒数
  * Whisper：モデル、device、compute_type、beam_size、temperature等
  * hallucination対策：condition_on_previous_text、repetition検知閾値
  * stable-ts：有効/無効、suppress_silence設定
  * 要約：ollama_host、model、max_tokens、temperature、prompt_mode
  * 出力：出力先、フォーマット、命名規則
* [6] 設定初期化：デフォルトYAMLを生成（上書き確認は任意）
* [7] 設定再読み込み：アプリ再起動無しで反映

---

## 6. 非機能要件（NFR）

### NFR-1: ローカル完結

* 音声・テキストが外部ネットワークへ送信されない設計であること。
* 依存コンポーネントはローカルで稼働（Ollama、Whisper推論、VAD）。

### NFR-2: 性能

* GPUあり環境で、実時間比（RTF）が一定以下を目標（例：RTF 0.3〜0.7）。
  ※数値は環境差が大きいので“目標値”として扱い、計測ログを必須化。
* 長時間（例：2時間）音声でメモリリークなく完走する。

### NFR-3: 品質（ハルシネーション抑制）

* 以下を満たすこと（受け入れ基準例）：

  * 同一単語または同一フレーズが**不自然に連続**する箇所を自動検知し、ログに警告を出す
  * 検知時に（a）抑制後処理（重複除去）または（b）その区間の再デコード（オプション）を提供
* 既定設定として

  * `condition_on_previous_text=False`
  * `word_timestamps=False`
  * VAD有効（推奨）
  * stable-tsの `suppress_silence` 有効（推奨）
    を採用する。

### NFR-4: 可搬性

* まずは Windows を主対象
  将来、Linux/macOSも動かせるよう、OS依存箇所（録音・パス）を分離する。

### NFR-5: 運用性

* ログ（INFO/DEBUG）をファイル出力し、処理時間・設定・エラーを追える。
* 例外発生時に「どの段階で失敗したか」が明確（[1/3]〜のステップ表示は踏襲）。

### NFR-6: セキュリティ

* Ollamaホストはデフォルト `127.0.0.1` に固定（外部バインドは明示設定が必要）。
* 出力ディレクトリの権限エラーを適切にハンドリングする。

---

## 7. 画面・UI要件（CLI）

### 7.1 起動画面

* タイトル表示
* ステップ進捗表示（例：[1/3] 設定読込 → [2/3] Ollama確認 → [3/3] モデル確認）
* 利用可能モデル一覧（Ollamaモデル＋埋め込みモデルが混在しても良いが、分類表示推奨）

### 7.2 操作性

* 入力ミス時は再入力を促す
* 処理中はスピナーや進捗（チャンク番号、経過時間）を表示

---

## 8. データ要件

### 8.1 ディレクトリ構成（例）

* `config.yaml`
* `prompts/`

  * `minutes.md`
  * `todo.md`
* `outputs/`

  * `2025-12-23_120000_meeting_transcript.md`
  * `2025-12-23_120000_meeting_summary.md`
* `logs/`

  * `app.log`

### 8.2 出力フォーマット（例）

* transcript.md：本文＋メタ（モデル、RTF、設定要約）
* summary.md：見出し、要点、TODO、決定事項、懸念点（プロンプトで規定）

---

## 9. 外部インタフェース要件

### 9.1 Ollama API

* `GET /api/tags` 等でモデル一覧取得（実装都合で差し替え可）
* `POST /api/generate`（またはチャット系エンドポイント）で要約生成
* タイムアウト、リトライ、ストリーミング有無を設定可能にする

---

## 10. 主要パラメータ（初期値案）

### Whisper（推奨初期値）

* model: `large-v3-turbo`
* device: `cuda`（不可ならcpu）
* compute_type: `float16`（GPU） / `int8`（CPU）
* condition_on_previous_text: `false`
* word_timestamps: `false`
* beam_size: 1〜5（高速重視なら小さめ）
* temperature: 0.0〜0.2（安定重視）

### VAD

* enabled: true
* min_speech_ms / min_silence_ms / threshold を調整可能に

### stable-ts

* enabled: true（ただし問題が出る環境ではoff可能）
* suppress_silence: true

---

## 11. 受け入れ基準（Acceptance Criteria）

1. **オフライン状態**（外部ネット遮断）でも、録音→文字起こし→要約まで完走する（Ollama含む）。
2. `prompts/*.md` を編集すると、アプリ再起動なしでも（設定再読み込み or 次回実行で）要約結果に反映される。
3. 2時間音声ファイルで、クラッシュせずに処理できる（GPU/CPUいずれでも）。
4. “突然の同一語反復”が発生しやすい音声で、既定設定により**明確に頻度が低減**している（少なくとも検知ログが出て抑制される）。
5. メニュー [1]〜[7] が動作し、エラー時に復帰可能（部分成功含む）。

---

## 12. リスク・論点（設計時に潰すべき点）

* **音声品質依存**：ノイズやBGMでVADが過剰除去する可能性（閾値のプリセットを複数用意）
* **モデル差**：large-v3-turbo以外でハルシネーション特性が変わる（モデル別プリセット）
* **日本語長文要約**：LLMのコンテキスト長不足（チャンク要約→統合要約の二段構成をオプション化）
* **Windows録音周り**：デバイス列挙API差（ライブラリ選定で吸収）

---

## 13. マイルストーン（実装の切り方）

1. **MVP**：ファイル→文字起こし→保存（要約なし）
2. 録音対応＋VAD
3. stable-ts統合（suppress_silence）
4. Ollama要約＋.mdプロンプト差し替え
5. 品質強化（反復検知・再デコード/除去・ログ整備）
6. 配布形態（venv + requirements / 1ファイルexe化 等）
